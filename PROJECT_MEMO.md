# PROJECT_MEMO - 経理ツール

## プロジェクト概要

**経費記録・領収書管理Webアプリ**

領収書の画像をアップロードすると、OCRで自動的に日付・金額・用途を読み取り、経費データとして保存。年月フィルター、Excelエクスポート、バックアップ機能付き。

- 場所: `~/Desktop/keiri-tool`
- 作成日: 2025-11-21
- 技術: HTML/CSS/JavaScript, Tesseract.js (OCR), SheetJS (Excel)

---

## ファイル構成

```
keiri-tool/
├── index.html      # メインページ
├── style.css       # スタイルシート
├── app.js          # アプリケーションロジック
├── README.md       # 使い方説明
└── PROJECT_MEMO.md # このファイル
```

---

## 完成した機能

### 1. 画像アップロード
- [x] クリックまたはドラッグ&ドロップで画像選択
- [x] スマホカメラ撮影対応（capture属性）
- [x] 画像プレビュー表示

### 2. 自動読み取り（OCR）
- [x] Tesseract.jsで日本語OCR実行
- [x] 日付抽出（YYYY年MM月DD日、YYYY/MM/DDなど）
- [x] 金額抽出（¥、円、合計などから）
- [x] 支払い方法判定（現金、クレジットカード、銀行振込）
- [x] 用途抽出（店名・商品名）
- [x] 読み取れた/読み取れなかった項目を色で表示（緑/赤）

### 3. データ入力フォーム
- [x] 日付、金額、用途、支払い方法、種別（出金/入金）、メモ
- [x] 日本語バリデーションメッセージ
- [x] 入力必須項目のハイライト表示

### 4. データ一覧表示
- [x] 保存した取引を一覧表示
- [x] 画像サムネイル付き
- [x] 削除機能

### 5. フィルター機能
- [x] 年で絞り込み
- [x] 月で絞り込み
- [x] 種別（出金/入金）で絞り込み
- [x] キーワード検索（用途・メモ）
- [x] フィルター適用時に合計金額表示

### 6. Excelエクスポート
- [x] SheetJSでExcelファイル生成
- [x] 日本語ヘッダー対応

### 7. バックアップ・復元
- [x] JSONファイルでバックアップ
- [x] 復元機能（既存データに追加）

### 8. レスポンシブ対応
- [x] スマホ・PC両対応のCSS

---

## 解決した問題と原因

### 1. Gemini API エラー
**問題**: `models/gemini-1.5-flash is not found for API version v1beta`

**原因**: Gemini APIのモデル名・エンドポイントが変更されていた

**解決策**: Gemini APIを諦め、Tesseract.js（OCR）に切り替え。APIキー不要で完全無料に。

### 2. フォームバリデーションが英語
**問題**: ブラウザのデフォルトバリデーションメッセージが英語で表示

**解決策**: `setCustomValidity()`で日本語メッセージを設定

### 3. 入力が必要な項目が分かりにくい
**問題**: OCRで読み取れなかった項目がどれか分かりにくい

**解決策**: CSSで赤（入力必要）/緑（読み取り済み）のハイライト表示を実装

---

## 現在の状態

**動作確認済み**
- 画像アップロード → OCR実行 → フォーム表示 → 保存 → 一覧表示
- フィルター、Excelエクスポート、バックアップ・復元

**注意点**
- OCRの精度は画像品質に依存
- 初回OCR時、ライブラリダウンロードに数秒かかる
- データはLocalStorageに保存（ブラウザキャッシュ消去でデータ消失）

---

## 使い方

### 基本的な使い方
1. `index.html` をブラウザで開く
2. 領収書の画像をアップロード
3. OCRが実行され、読み取り結果がフォームに入力される
4. 赤い項目を手動で入力
5. 「保存」をクリック
6. 一覧に追加される

### データのバックアップ
1. 「バックアップ」ボタンをクリック
2. JSONファイルがダウンロードされる
3. 安全な場所に保管

### 過去のデータを探す
1. 年・月フィルターで絞り込み
2. またはキーワード検索

### Excelエクスポート
1. 「Excelエクスポート」をクリック
2. `.xlsx`ファイルがダウンロードされる

---

## 次にやりたいこと候補

- [ ] OCR精度向上（画像の前処理追加）
- [ ] カテゴリ分類機能
- [ ] 月次・年次レポート
- [ ] グラフ表示（支出推移など）
- [ ] PDF出力
- [ ] 複数画像の一括アップロード
- [ ] クラウド同期（Firebase等）
- [ ] PWA化（オフライン対応）

---

## 更新履歴

### 2025-11-21（夕方）- 銀行振込画面対応
- 銀行振込完了画面のOCR対応を追加
  - 日付パターン追加: `振込予定日:` `振込日:` 形式
  - 金額パターン追加: `振込金額: 4,244円` 形式
  - 支払い方法: `振込`キーワードで自動的に「銀行振込」を設定
  - 用途: `受取人名:` から振込先を自動抽出、なければ`金融機関名`を使用

### 2025-11-21（午後）- Amazon領収書対応
- Amazon領収書のOCR対応を追加
  - 日付パターン追加: `注文日: 2025年11月19日` 形式
  - 金額パターン追加: `¥12,698` 形式（円なし）、`注文合計:`、`ご請求額:`
  - 支払い方法: `Amazonギフトカード` + クレジットカード併用対応

### 2025-11-21
- 初版作成
- 基本機能（画像アップロード、OCR、保存、一覧表示）
- フィルター機能
- バックアップ・復元機能
- Excelエクスポート
- 入力必須項目のハイライト表示（赤/緑）
