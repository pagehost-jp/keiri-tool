# マイグレーションガイド

## 概要

このガイドでは、旧データ構造 `/transactions` から新データ構造 `/users/{uid}/transactions` へのマイグレーション手順を説明します。

## なぜマイグレーションが必要？

### 旧構造の問題点
- **セキュリティ**: 全ユーザーのデータが同じコレクションに保存
- **プライバシー**: 他人の経理データが開発者のストレージに保存される
- **料金負担**: 開発者が全ユーザーの料金を負担

### 新構造のメリット
- ✅ ユーザーごとにデータが完全分離
- ✅ Firestoreセキュリティルールで保護
- ✅ 将来的な共有機能の基盤
- ✅ 有料化への対応が容易

---

## マイグレーション手順

### ⚠️ 重要な注意事項

1. **必ずバックアップを取る**
2. **マイグレーション中は他のユーザーに使わせない**
3. **移行後に動作確認してから旧データを削除**

---

### Step 1: セキュリティルールのデプロイ

1. **Firebaseコンソールを開く**
   - https://console.firebase.google.com/
   - プロジェクト `keiri-tool-bc599` を選択

2. **Firestoreセキュリティルールを更新**
   - 左メニュー → `Firestore Database` → `ルール` タブ
   - `firestore.rules` の内容をコピペ
   - **公開** ボタンをクリック

3. **確認**
   - エラーが出ないことを確認

---

### Step 2: データのバックアップ

1. **アプリを開く**
   - https://pagehost-jp.github.io/keiri-tool/

2. **Googleでログイン**

3. **ブラウザのコンソールを開く**
   - Windows/Linux: `F12` または `Ctrl + Shift + J`
   - Mac: `Cmd + Option + J`

4. **バックアップを実行**
   ```javascript
   exportOldTransactions()
   ```

5. **JSONファイルがダウンロードされる**
   - ファイル名: `transactions_backup_before_migrate_YYYY-MM-DD.json`
   - このファイルを安全な場所に保存

---

### Step 3: データのマイグレーション

1. **ブラウザのコンソールで実行**
   ```javascript
   migrateTransactionsToUserCollections()
   ```

2. **確認ダイアログが表示される**
   - 「OK」をクリック

3. **進行状況がコンソールに表示される**
   ```
   移行対象件数: 100
   コミット: 100件完了
   マイグレーション完了！合計 100件
   ```

4. **完了ダイアログが表示される**
   - 「OK」をクリック

---

### Step 4: 動作確認

1. **データが正しく表示されるか確認**
   - 画面をリロード
   - 一覧にデータが表示されるか
   - 新規追加が動作するか
   - 削除が動作するか

2. **Firebaseコンソールで確認**
   - `Firestore Database` → `データ` タブ
   - `/users/{あなたのUID}/transactions` にデータがあるか確認

3. **旧データも確認**
   - `/transactions` にまだデータが残っているか確認

---

### Step 5: 旧データの削除（オプション）

⚠️ **新構造で問題なく動作することを確認してから実行**

1. **ブラウザのコンソールで実行**
   ```javascript
   deleteOldTransactions()
   ```

2. **2回確認ダイアログが表示される**
   - 本当に削除してよいか確認
   - 「OK」を2回クリック

3. **削除完了**
   ```
   旧データ削除完了: 100件
   ```

---

## トラブルシューティング

### エラー: "permission-denied"

**原因**: Firestoreセキュリティルールが正しくデプロイされていない

**解決策**:
1. Firebaseコンソールでルールを確認
2. `firestore.rules` の内容を再度コピペして公開

### エラー: "ログインしていません"

**原因**: 認証されていない状態でマイグレーションを実行

**解決策**:
1. Googleアカウントでログイン
2. 再度マイグレーションを実行

### データが表示されない

**原因**: ページをリロードしていない、または認証エラー

**解決策**:
1. ページをリロード（`F5` または `Cmd + R`）
2. 一度ログアウトしてから再ログイン
3. ブラウザのコンソールでエラーを確認

### マイグレーションが途中で止まる

**原因**: ネットワークエラー、Firebaseの制限

**解決策**:
1. インターネット接続を確認
2. 再度マイグレーションを実行（重複は自動で回避される）
3. データ量が多い場合は時間がかかるので待つ

---

## マイグレーション後の確認リスト

- [ ] セキュリティルールがデプロイされている
- [ ] バックアップファイルが保存されている
- [ ] マイグレーションが完了している
- [ ] 新しいデータ構造で動作確認済み
- [ ] 新規追加・削除が正常に動作
- [ ] （オプション）旧データを削除した

---

## サポート

問題が発生した場合は、以下の情報を添えて報告してください：

1. ブラウザのコンソールのエラーメッセージ
2. 実行したコマンド
3. 発生したタイミング

---

## 参考情報

- **Firebaseプロジェクト**: keiri-tool-bc599
- **旧データ構造**: `/transactions/{id}`
- **新データ構造**: `/users/{uid}/transactions/{id}`
- **共有データ構造（将来）**: `/shared/{sharedId}/transactions/{id}`
